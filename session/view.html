<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dettagli Consenso</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background:#f8f9fa; }
    .card { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    h2 { margin-top:0; color:#2c3e50; }
    .field { margin:8px 0; }
    .label { font-weight:bold; }
    .error { color:red; margin-top:20px; }
    .media { margin-top:15px; }
    img { max-width:300px; display:block; margin-top:10px; }
    audio { margin-top:10px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Dettagli Consenso</h2>
    <div id="content">Caricamento...</div>
  </div>

  <script>
    // Configurazione Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCz6FvQwCUrI2Q9YJf5UjxDhmG7us1sCwY",
      authDomain: "trueconsent-cab73.firebaseapp.com",
      projectId: "trueconsent-cab73",
      storageBucket: "trueconsent-cab73.appspot.com"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Recupera sessionId dall'URL
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get("sessionId");

    const contentDiv = document.getElementById("content");

    if (!sessionId) {
      contentDiv.innerHTML = "<p class='error'>❌ sessionId mancante nell'URL</p>";
    } else {
      db.collection("sessions").doc(sessionId).get()
        .then(async (doc) => {
          if (!doc.exists) {
            contentDiv.innerHTML = "<p class='error'>❌ Consenso non trovato</p>";
            return;
          }

          const data = doc.data();
          let html = `
            <div class="field"><span class="label">ID Consenso:</span> ${doc.id}</div>
            <div class="field"><span class="label">Tipo:</span> ${data.type || "-"}</div>
            <div class="field"><span class="label">Controparte:</span> ${data.counterpartName || "-"} (${data.counterpartEmail || "-"})</div>
            <div class="field"><span class="label">Telefono:</span> ${data.counterpartPhone || "-"}</div>
            <div class="field"><span class="label">Creato:</span> ${data.startAt?.toDate ? data.startAt.toDate() : "-"}</div>
            <div class="field"><span class="label">Scadenza:</span> ${data.endAt?.toDate ? data.endAt.toDate() : "-"}</div>
            <div class="field"><span class="label">Stato:</span> ${data.status || "-"}</div>
          `;

          // Firma
          if (data.signaturePath) {
            const url = await storage.ref(data.signaturePath).getDownloadURL();
            html += `<div class="media"><span class="label">Firma:</span><br><img src="${url}" alt="Firma"></div>`;
          }

          // Selfie
          if (data.selfiePath) {
            const url = await storage.ref(data.selfiePath).getDownloadURL();
            html += `<div class="media"><span class="label">Selfie:</span><br><img src="${url}" alt="Selfie"></div>`;
          }

          // Audio
          if (data.audioPath) {
            const url = await storage.ref(data.audioPath).getDownloadURL();
            html += `<div class="media"><span class="label">Audio:</span><br><audio controls src="${url}"></audio></div>`;
          }

          contentDiv.innerHTML = html;
        })
        .catch((err) => {
          console.error(err);
          contentDiv.innerHTML = "<p class='error'>❌ Errore caricamento consenso</p>";
        });
    }
  </script>
</body>
</html>
