<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dettagli Consenso</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      font-size: 15px;
    }
    .section { margin-bottom: 18px; }
    button {
      background: #6c63ff;
      color: #fff;
      border: none;
      padding: 10px 18px;
      margin-right: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #554ce0; }
    img {
      max-width: 220px;
      border: 1px solid #ddd;
      padding: 4px;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    img:hover { transform: scale(1.02); }
    audio { width: 100%; min-height: 60px; border: 1px solid #ccc; border-radius: 6px; }
    #lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; }
    #lightbox img { max-width:90%; max-height:90%; }
  </style>
</head>
<body>
  <h3>üìÑ Dettagli Consenso</h3>
  <button id="printBtn">üñ®Ô∏è Stampa consenso</button>
  <button id="downloadZipBtn">üì¶ Scarica consenso completo (.zip)</button>
  <div id="details">‚è≥ Caricamento...</div>
  <div id="media"></div>

  <div id="lightbox"><img src="" alt="zoom"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyATGSpPkvYLxazHHWW90oWWkgxoEsTkayI",
      authDomain: "trueconsent-cab73.firebaseapp.com",
      projectId: "trueconsent-cab73",
      storageBucket: "trueconsent-cab73.firebasestorage.app"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const params = new URLSearchParams(window.location.search);
    const userId = params.get("userId");
    const sessionId = params.get("sessionId");

    async function loadConsent() {
      const refDoc = doc(db, "users", userId, "sessions", sessionId);
      const snap = await getDoc(refDoc);
      if (!snap.exists()) {
        document.getElementById("details").innerText = "‚ùå Consenso non trovato.";
        return;
      }

      const d = snap.data();
      let html = `
        <div class="section"><b>ID Consenso:</b> ${sessionId}</div>
        <div class="section"><b>Tipo:</b> ${d.type}</div>
        <div class="section"><b>Stato:</b> ${d.status}</div>
        <div class="section"><b>Controparte:</b> ${d.counterpartName}</div>
        <div class="section"><b>Data inizio:</b> ${d.startAt?.toDate ? d.startAt.toDate() : "-"}</div>
      `;
      document.getElementById("details").innerHTML = html;

      let mediaHtml = "";
      const files = [];

      if (d.signaturePath) {
        const url = await getDownloadURL(ref(storage, d.signaturePath));
        mediaHtml += `<div><b>Firma:</b><br><img src="${url}" class="zoomable"></div>`;
        files.push({ name: "firma.png", url });
      }
      if (d.selfiePath) {
        const url = await getDownloadURL(ref(storage, d.selfiePath));
        mediaHtml += `<div><b>Selfie:</b><br><img src="${url}" class="zoomable"></div>`;
        files.push({ name: "selfie.jpg", url });
      }
      if (d.audioPath) {
        const url = await getDownloadURL(ref(storage, d.audioPath));
        mediaHtml += `<div><b>Audio:</b><br><audio controls src="${url}"></audio></div>`;
        files.push({ name: "audio.m4a", url });
      }

      document.getElementById("media").innerHTML = mediaHtml;

      // Lightbox zoom
      document.querySelectorAll(".zoomable").forEach(img => {
        img.onclick = () => {
          document.getElementById("lightbox").style.display = "flex";
          document.querySelector("#lightbox img").src = img.src;
        };
      });
      document.getElementById("lightbox").onclick = () => {
        document.getElementById("lightbox").style.display = "none";
      };

      // Stampa
      document.getElementById("printBtn").onclick = () => window.print();

      // Download ZIP
      document.getElementById("downloadZipBtn").onclick = async () => {
        const zip = new JSZip();
        for (const f of files) {
          const res = await fetch(f.url);
          const blob = await res.blob();
          zip.file(f.name, blob);
        }
        const html = new Blob([document.documentElement.outerHTML], { type: "text/html" });
        zip.file(`consenso_${sessionId}.html`, html);
        const blob = await zip.generateAsync({ type: "blob" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `consenso_${sessionId}.zip`;
        a.click();
      };
    }

    await loadConsent();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <footer style="margin-top:40px;font-size:13px;color:#555;border-top:1px solid #ccc;padding-top:10px;">
    <p><b>Informativa legale</b></p>
    <p>Questo consenso digitale √® stato creato tramite <b>TrueConsent</b> ed √® valido secondo le regole indicate nei <a href="https://atroccolo-pixel.github.io/terms.html">Termini e Condizioni ufficiali</a>.</p>
    <p>I file (immagini, audio e metadati) costituiscono documentazione probatoria ai sensi dell‚Äôart. 234 c.p.p. e 2712 c.c.
    L‚Äôintegrit√† √® garantita da timestamp e hash univoco. La conservazione personale tutela entrambe le parti.</p>
    <p>¬© 2025 TrueConsent ‚Äì Tutti i diritti riservati</p>
  </footer>
</body>
</html>
